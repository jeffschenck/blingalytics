(function(e){jQuery.fn.blingalytics=function(t){var n={url:"/report/",reportCodeName:"report",callback:e.noop,rowCallback:function(e,t,n){return e}};if(t)e.extend(n,t);return this.each(function(){var t=e(this);t.empty().addClass("bl_container");var r=e('<ul class="errors"></ul>');r.prependTo(t);var i={metadata:"1",report:n.reportCodeName};e.getJSON(n.url,i,function(i){function v(t,n,i){var s=t+"&"+p.find("input, select, textarea").serialize();e.getJSON(s,n,function(e){if(e.poll){setTimeout(function(){v(t,n,i)},500)}else if(e.errors.length){r.empty();for(var s=0;s<e.errors.length;s++){r.append("<li>"+e.errors[s]+"</li>")}i({iTotalRecords:0,iTotalDisplayRecords:0,aaData:[]})}else{var o=d.find("tfoot th");for(var s=0;s<e.footer.length;s++){o.eq(s).html(e.footer[s])}i(e)}})}function b(){var t=m.fnSettings().sAjaxSource+"&"+p.find("input, select, textarea").serialize()+"&format=csv";e.getJSON(t,function(e){if(e.poll){setTimeout(b,500)}else if(e.errors.length){r.empty();for(var n=0;n<e.errors.length;n++){r.append("<li>"+e.errors[n]+"</li>")}}else{document.location.href=t+"&download=1";y.removeClass("disabled")}})}if(i.errors.length){r.empty();for(var s=0;s<i.errors.length;s++){r.append("<li>"+i.errors[s]+"</li>")}return}var o=i.header;var u=i.default_sort;var a=[];var f=[];var l="";var c="";for(var s=0;s<o.length;s++){a.push({bSearchable:false,bSortable:o[s].sortable,sClass:"",sName:o[s].key,sTitle:o[s].label,aTargets:[s]});var h=o[s].className||"";h=o[s].hidden?h+" bl_hidden":h;f.push(h);l+='<th class="'+h+'">'+o[s].label+"</th>";c+='<th class="'+h+'"></th>';if(o[s].key==u[0]){u=[parseInt(s),u[1]]}}var p=e('<ul class="widgets"></ul>');t.append(p);for(var s=0;s<i.widgets.length;s++){p.append("<li>"+i.widgets[s]+"</li>")}e("<button>Run Report</button>").appendTo(p).click(function(){m.fnSort([u])});var d=e('<table class="bl_table display">'+"<thead><tr>"+l+"</tr></thead>"+"<tfoot><tr>"+c+"</tr></tfoot>"+"<tbody></tbody>"+"</table>");t.append(d);var m=d.dataTable({aoColumnDefs:a,sPaginationType:"full_numbers",sDom:'<"H"<"dataTables_options">lr>t<"F"ip>',bAutoWidth:false,bFilter:false,bJQueryUI:true,bProcessing:true,bStateSave:true,bServerSide:true,sAjaxSource:n.url+"?report="+n.reportCodeName,aaSorting:[u],iDeferLoading:0,iDisplayLength:25,fnRowCallback:function(e,t,r){var i=e.children;for(var s=0;s<i.length;s++){i[s].className+=f[s]}return n.rowCallback(e,t,r)},fnServerData:v,fnHeaderCallback:function(t,n,r,i,s){var o=e(t);o.find("th").removeClass("sorting");o.find("th:has(.ui-icon-triangle-1-n, .ui-icon-triangle-1-s)").addClass("sorting")}});var g=e('<button class="btn btn-mini"><i class="icon-ban-circle"></i> Cache</button>');g.click(function(t){if(g.hasClass("disabled")){return}g.addClass("disabled");var n=m.fnSettings().sAjaxSource+"&"+p.find("input, select, textarea").serialize()+"&killcache=1";e.getJSON(n,function(e){g.removeClass("disabled")})});t.find(".dataTables_options").append(g);var y=e('<button class="btn btn-mini"><i class="icon-download"></i> CSV</button>');y.click(function(){if(y.hasClass("disabled")){return}y.addClass("disabled");b()});t.find(".dataTables_options").append(y);n.callback()})})}})(jQuery)